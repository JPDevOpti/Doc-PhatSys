# MongoDB Atlas

## Descripción General
MongoDB Atlas es la plataforma de base de datos en la nube utilizada por PathSys para alojar y gestionar las bases de datos MongoDB. Proporciona alta disponibilidad, escalabilidad automática, y herramientas avanzadas de monitoreo y seguridad.

## Configuración del Cluster

### Especificaciones del Cluster
- **Tier**: M10 (Producción) / M0 (Desarrollo)
- **Región**: us-east-1 (Virginia del Norte)
- **Proveedor**: AWS
- **Versión MongoDB**: 7.0+
- **Replica Set**: 3 nodos para alta disponibilidad

### Configuración de Red
```javascript
// Configuración de IP Whitelist
{
  "ipWhitelist": [
    "0.0.0.0/0",  // Desarrollo (restringir en producción)
    "10.0.0.0/8", // Red interna
    "172.16.0.0/12", // Docker networks
    "192.168.0.0/16"  // Redes locales
  ]
}
```

### Variables de Entorno
```bash
# Configuración de conexión
MONGODB_URI=mongodb+srv://username:password@cluster.mongodb.net/pathsys?retryWrites=true&w=majority
MONGODB_DATABASE=pathsys
MONGODB_TEST_DATABASE=pathsys_test

# Configuración de conexión pool
MONGODB_MIN_POOL_SIZE=5
MONGODB_MAX_POOL_SIZE=50
MONGODB_MAX_IDLE_TIME=30000
MONGODB_CONNECT_TIMEOUT=10000
MONGODB_SOCKET_TIMEOUT=30000
```

## Bases de Datos

### Base de Datos Principal: pathsys
```javascript
// Colecciones principales
{
  "patients": "Información de pacientes",
  "cases": "Casos patológicos",
  "pathologists": "Patólogos certificados",
  "residents": "Residentes en formación",
  "auxiliaries": "Personal auxiliar",
  "entities": "Entidades médicas",
  "tests": "Catálogo de pruebas",
  "diseases": "Catálogo de enfermedades",
  "users": "Usuarios del sistema",
  "tickets": "Tickets de soporte",
  "approvals": "Solicitudes de aprobación",
  "billing": "Facturación y pagos"
}
```

### Base de Datos de Contadores: pathsys_counters
```javascript
// Colecciones de contadores
{
  "case_counters": "Contadores de casos por año",
  "consecutive_tickets": "Contadores de tickets",
  "approval_counters": "Contadores de aprobaciones"
}
```

### Base de Datos de Auditoría: pathsys_audit
```javascript
// Colecciones de auditoría
{
  "user_activities": "Actividades de usuarios",
  "data_changes": "Cambios en datos críticos",
  "system_events": "Eventos del sistema",
  "security_logs": "Logs de seguridad"
}
```

## Índices y Optimización

### Índices Críticos por Colección

#### Pacientes
```javascript
db.patients.createIndex({ "identification": 1 }, { unique: true })
db.patients.createIndex({ "patient_name": "text" })
db.patients.createIndex({ "entity_info.entity_id": 1 })
db.patients.createIndex({ "created_at": 1 })
```

#### Casos
```javascript
db.cases.createIndex({ "case_code": 1 }, { unique: true })
db.cases.createIndex({ "patient_info.patient_id": 1 })
db.cases.createIndex({ "entity_info.entity_id": 1 })
db.cases.createIndex({ "case_state.current_state": 1 })
db.cases.createIndex({ "assigned_pathologist.pathologist_id": 1 })
db.cases.createIndex({ "created_at": 1 })
```

#### Usuarios
```javascript
db.users.createIndex({ "username": 1 }, { unique: true })
db.users.createIndex({ "email": 1 }, { unique: true })
db.users.createIndex({ "user_type": 1, "is_active": 1 })
db.users.createIndex({ "profile_id": 1 })
```

### Estrategias de Optimización

#### Compound Indexes
```javascript
// Búsquedas frecuentes optimizadas
db.cases.createIndex({ 
  "entity_info.entity_id": 1, 
  "case_state.current_state": 1, 
  "created_at": -1 
})

db.billing.createIndex({ 
  "entity_id": 1, 
  "payment_status": 1, 
  "billing_date": -1 
})
```

#### Text Indexes
```javascript
// Búsqueda de texto completo
db.patients.createIndex({ 
  "patient_name": "text", 
  "identification": "text" 
})

db.diseases.createIndex({ 
  "name": "text", 
  "description": "text", 
  "code": "text" 
})
```

## Seguridad y Acceso

### Usuarios de Base de Datos

#### Usuario de Aplicación
```javascript
{
  "username": "pathsys_app",
  "roles": [
    {
      "role": "readWrite",
      "db": "pathsys"
    },
    {
      "role": "readWrite", 
      "db": "pathsys_counters"
    },
    {
      "role": "readWrite",
      "db": "pathsys_audit"
    }
  ]
}
```

#### Usuario de Solo Lectura
```javascript
{
  "username": "pathsys_readonly",
  "roles": [
    {
      "role": "read",
      "db": "pathsys"
    },
    {
      "role": "read",
      "db": "pathsys_audit"
    }
  ]
}
```

#### Usuario de Backup
```javascript
{
  "username": "pathsys_backup",
  "roles": [
    {
      "role": "backup",
      "db": "admin"
    },
    {
      "role": "read",
      "db": "pathsys"
    },
    {
      "role": "read",
      "db": "pathsys_counters"
    },
    {
      "role": "read",
      "db": "pathsys_audit"
    }
  ]
}
```

### Configuración de Seguridad

#### Encriptación
- **Encriptación en Tránsito**: TLS 1.2+
- **Encriptación en Reposo**: AES-256
- **Encriptación de Backups**: Automática

#### Autenticación
- **Método**: SCRAM-SHA-256
- **Rotación de Contraseñas**: Cada 90 días
- **Complejidad**: Mínimo 12 caracteres, mayúsculas, minúsculas, números, símbolos

## Monitoreo y Alertas

### Métricas Clave
- **Conexiones Activas**: Máximo 80% del límite
- **Uso de CPU**: Alerta si > 80%
- **Uso de Memoria**: Alerta si > 85%
- **Uso de Almacenamiento**: Alerta si > 80%
- **Latencia de Operaciones**: Alerta si > 100ms promedio
- **Errores de Conexión**: Alerta si > 5% tasa de error

### Configuración de Alertas
```javascript
{
  "alerts": [
    {
      "type": "HOST_METRIC",
      "metric": "CONNECTIONS",
      "threshold": 80,
      "operator": "GREATER_THAN",
      "units": "PERCENT_UTILIZATION"
    },
    {
      "type": "HOST_METRIC", 
      "metric": "CPU_USAGE",
      "threshold": 80,
      "operator": "GREATER_THAN",
      "units": "PERCENT"
    },
    {
      "type": "HOST_METRIC",
      "metric": "MEMORY_USAGE", 
      "threshold": 85,
      "operator": "GREATER_THAN",
      "units": "PERCENT"
    }
  ]
}
```

### Dashboard de Monitoreo
- **Real-time Performance**: Métricas en tiempo real
- **Query Performance**: Análisis de consultas lentas
- **Index Usage**: Utilización de índices
- **Connection Metrics**: Estadísticas de conexiones
- **Storage Metrics**: Uso y crecimiento de almacenamiento

## Backup y Recuperación

### Configuración de Backup Automático
```javascript
{
  "backupPolicy": {
    "enabled": true,
    "referenceHourOfDay": 3,
    "referenceMinuteOfHour": 0,
    "restoreWindowDays": 7,
    "updateSnapshots": true
  }
}
```

### Estrategia de Backup
- **Backup Continuo**: Point-in-time recovery
- **Snapshots Diarios**: Retención de 7 días
- **Snapshots Semanales**: Retención de 4 semanas
- **Snapshots Mensuales**: Retención de 12 meses

### Procedimiento de Recuperación
```bash
# Restauración desde snapshot específico
mongorestore --uri="mongodb+srv://cluster.mongodb.net" \
  --archive=pathsys_backup_20240101.archive \
  --gzip \
  --drop

# Restauración point-in-time
# Usar Atlas UI para seleccionar timestamp específico
```

## Escalabilidad

### Escalado Vertical
- **Tier Upgrade**: M10 → M20 → M30 según crecimiento
- **Storage Scaling**: Automático hasta límites del tier
- **IOPS Scaling**: Automático basado en carga

### Escalado Horizontal
- **Read Replicas**: Configuración de réplicas de solo lectura
- **Sharding**: Implementación cuando se superen 500GB
- **Regional Clusters**: Para distribución geográfica

### Configuración de Auto-Scaling
```javascript
{
  "autoScaling": {
    "compute": {
      "enabled": true,
      "scaleDownEnabled": true,
      "minInstanceSize": "M10",
      "maxInstanceSize": "M30"
    },
    "diskGBEnabled": true
  }
}
```

## Migración y Mantenimiento

### Ventanas de Mantenimiento
- **Horario Preferido**: Domingos 2:00 AM - 6:00 AM UTC-5
- **Notificación**: 48 horas de anticipación
- **Duración Típica**: 15-30 minutos

### Procedimientos de Migración
```bash
# Migración de datos desde instancia local
mongodump --host localhost:27017 --db pathsys --out ./backup
mongorestore --uri="mongodb+srv://cluster.mongodb.net" \
  --db pathsys ./backup/pathsys

# Migración con transformación de datos
mongodump --host localhost:27017 --db pathsys --collection patients
# Aplicar transformaciones necesarias
mongorestore --uri="mongodb+srv://cluster.mongodb.net" \
  --db pathsys --collection patients ./transformed_data
```

### Actualizaciones de Versión
- **Proceso**: Rolling upgrade sin downtime
- **Testing**: Validación en cluster de pruebas
- **Rollback**: Plan de rollback automático

## Integración con Aplicación

### Connection String Patterns
```python
# Configuración de conexión con opciones
MONGODB_URI = (
    "mongodb+srv://username:password@cluster.mongodb.net/"
    "pathsys?retryWrites=true&w=majority&readPreference=primary"
    "&maxPoolSize=50&minPoolSize=5&maxIdleTimeMS=30000"
    "&connectTimeoutMS=10000&socketTimeoutMS=30000"
)
```

### Configuración de Motor
```python
import motor.motor_asyncio
from pymongo import MongoClient

# Configuración asíncrona con Motor
client = motor.motor_asyncio.AsyncIOMotorClient(
    MONGODB_URI,
    maxPoolSize=50,
    minPoolSize=5,
    maxIdleTimeMS=30000,
    connectTimeoutMS=10000,
    socketTimeoutMS=30000,
    retryWrites=True,
    w="majority"
)

# Configuración síncrona con PyMongo
sync_client = MongoClient(
    MONGODB_URI,
    maxPoolSize=50,
    minPoolSize=5,
    maxIdleTimeMS=30000,
    connectTimeoutMS=10000,
    socketTimeoutMS=30000
)
```

## Costos y Optimización

### Estimación de Costos
- **M10 Cluster**: ~$57/mes (Desarrollo)
- **M20 Cluster**: ~$120/mes (Producción pequeña)
- **M30 Cluster**: ~$240/mes (Producción mediana)
- **Data Transfer**: $0.10/GB (salida)
- **Backup Storage**: $2.50/GB/mes

### Optimización de Costos
- **Right-sizing**: Monitoreo de utilización para ajustar tier
- **Data Lifecycle**: Archivado de datos históricos
- **Index Optimization**: Eliminación de índices no utilizados
- **Query Optimization**: Mejora de consultas ineficientes

## Troubleshooting

### Problemas Comunes

#### Conexiones Lentas
```bash
# Verificar latencia de red
ping cluster-shard-00-00.mongodb.net

# Verificar configuración de pool
db.runCommand({serverStatus: 1}).connections
```

#### Consultas Lentas
```javascript
// Habilitar profiler para consultas > 100ms
db.setProfilingLevel(1, { slowms: 100 })

// Analizar consultas lentas
db.system.profile.find().sort({ ts: -1 }).limit(5)
```

#### Problemas de Memoria
```javascript
// Verificar uso de memoria
db.serverStatus().mem

// Verificar índices en memoria
db.stats().indexSizes
```

### Herramientas de Diagnóstico
- **MongoDB Compass**: GUI para exploración y análisis
- **Atlas Performance Advisor**: Recomendaciones de índices
- **Atlas Real-time Performance Panel**: Monitoreo en tiempo real
- **MongoDB Profiler**: Análisis detallado de operaciones

## Mejores Prácticas

### Diseño de Esquemas
- Evitar documentos > 16MB
- Usar referencias para relaciones complejas
- Implementar validación de esquemas
- Considerar patrones de acceso en el diseño

### Operaciones
- Usar bulk operations para inserciones masivas
- Implementar paginación para consultas grandes
- Usar proyecciones para limitar datos transferidos
- Implementar retry logic para operaciones críticas

### Seguridad
- Rotar credenciales regularmente
- Usar principio de menor privilegio
- Implementar auditoría de accesos
- Mantener whitelist de IPs actualizada