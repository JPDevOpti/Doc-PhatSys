---
id: vision-general-bd
title: VisiÃ³n General de la Base de Datos
sidebar_position: 1
---

# VisiÃ³n General de la Base de Datos

PathSys utiliza **MongoDB** como sistema de gestiÃ³n de base de datos NoSQL, proporcionando flexibilidad y escalabilidad para el manejo de datos mÃ©dicos complejos. El sistema estÃ¡ diseÃ±ado para funcionar tanto en entornos de desarrollo local con Docker como en producciÃ³n con MongoDB Atlas.

## Stack TecnolÃ³gico

<div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', gap: 12}}>
  <div style={{background: '#f9fafb', border: '1px solid #e5e7eb', borderRadius: 8, padding: 16}}>
    <div style={{fontWeight: 600, color: '#374151'}}>Base de Datos</div>
    <div style={{fontSize: 13, color: '#6b7280', marginTop: 6}}>MongoDB 7.0 - Base de datos NoSQL orientada a documentos con soporte para consultas complejas y agregaciones.</div>
  </div>
  <div style={{background: '#f9fafb', border: '1px solid #e5e7eb', borderRadius: 8, padding: 16}}>
    <div style={{fontWeight: 600, color: '#374151'}}>Driver AsÃ­ncrono</div>
    <div style={{fontSize: 13, color: '#6b7280', marginTop: 6}}>Motor - Driver asÃ­ncrono oficial de MongoDB para Python, optimizado para FastAPI.</div>
  </div>
  <div style={{background: '#f9fafb', border: '1px solid #e5e7eb', borderRadius: 8, padding: 16}}>
    <div style={{fontWeight: 600, color: '#374151'}}>ValidaciÃ³n</div>
    <div style={{fontSize: 13, color: '#6b7280', marginTop: 6}}>Pydantic - ValidaciÃ³n de datos y serializaciÃ³n automÃ¡tica con tipos Python.</div>
  </div>
  <div style={{background: '#f9fafb', border: '1px solid #e5e7eb', borderRadius: 8, padding: 16}}>
    <div style={{fontWeight: 600, color: '#374151'}}>AdministraciÃ³n</div>
    <div style={{fontSize: 13, color: '#6b7280', marginTop: 6}}>Mongo Express - Interfaz web para administraciÃ³n y visualizaciÃ³n de datos.</div>
  </div>
</div>

## ConfiguraciÃ³n de ConexiÃ³n

### Variables de Entorno

El sistema utiliza las siguientes variables de entorno para la configuraciÃ³n de la base de datos:

```bash
# ConfiguraciÃ³n bÃ¡sica
MONGODB_URL=mongodb://localhost:27017
DATABASE_NAME=lime_pathsys
ENVIRONMENT=development
DEBUG=True

# ConfiguraciÃ³n de Atlas (ProducciÃ³n)
MONGODB_URL=mongodb+srv://user:password@cluster.mongodb.net/
DATABASE_NAME=lime_pathsys
ENVIRONMENT=production
DEBUG=False
```

### ParÃ¡metros de ConexiÃ³n

```python
connection_options = {
    "serverSelectionTimeoutMS": 5000,    # Timeout para selecciÃ³n de servidor
    "connectTimeoutMS": 10000,           # Timeout de conexiÃ³n inicial
    "socketTimeoutMS": 20000,            # Timeout de socket
    "maxPoolSize": 10,                   # MÃ¡ximo de conexiones en pool
    "minPoolSize": 1,                    # MÃ­nimo de conexiones en pool
    "maxIdleTimeMS": 30000,              # Tiempo mÃ¡ximo de inactividad
    "retryWrites": True,                 # Reintentar escrituras
    "retryReads": True                   # Reintentar lecturas
}
```

## Entornos de Despliegue

### ğŸ³ Desarrollo Local con Docker

Para desarrollo local, PathSys utiliza Docker Compose con los siguientes servicios:

```yaml
services:
  mongodb:
    image: mongo:7.0
    ports:
      - "27017:27017"
    volumes:
      - mongodb_dev_data:/data/db
    environment:
      - MONGO_INITDB_DATABASE=pathsys_dev

  mongo-express:
    image: mongo-express:1.0.0
    ports:
      - "8081:8081"
    environment:
      - ME_CONFIG_MONGODB_SERVER=mongodb
      - ME_CONFIG_BASICAUTH_USERNAME=admin
      - ME_CONFIG_BASICAUTH_PASSWORD=admin123
```

**Acceso:**
- **MongoDB**: `localhost:27017`
- **Mongo Express**: `http://localhost:8081`

### â˜ï¸ ProducciÃ³n con MongoDB Atlas

Para producciÃ³n, el sistema se conecta a MongoDB Atlas:

```bash
MONGODB_URL=mongodb+srv://cluster0.dujsqez.mongodb.net/
DATABASE_NAME=lime_pathsys
```

**CaracterÃ­sticas de Atlas:**
- Cluster distribuido y replicado
- Backups automÃ¡ticos
- Monitoreo y alertas
- Escalabilidad automÃ¡tica
- Seguridad avanzada

## Arquitectura de Datos

### PatrÃ³n de DiseÃ±o

PathSys implementa un patrÃ³n de **Repository + Service** para el acceso a datos:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Controllers   â”‚â”€â”€â”€â–¶â”‚    Services     â”‚â”€â”€â”€â–¶â”‚  Repositories   â”‚
â”‚   (FastAPI)     â”‚    â”‚  (Business      â”‚    â”‚   (MongoDB      â”‚
â”‚                 â”‚    â”‚   Logic)        â”‚    â”‚    Access)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                       â”‚
                                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                               â”‚    MongoDB      â”‚
                                               â”‚   Collections   â”‚
                                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### GestiÃ³n de Conexiones

```python
class DatabaseManager:
    """Gestor centralizado de conexiones a MongoDB"""
    
    def __init__(self):
        self.client: Optional[AsyncIOMotorClient] = None
        self.database: Optional[AsyncIOMotorDatabase] = None
    
    async def connect_to_mongo(self):
        """Establecer conexiÃ³n con verificaciÃ³n de salud"""
        self.client = AsyncIOMotorClient(settings.MONGODB_URL)
        self.database = self.client[settings.DATABASE_NAME]
        await self.client.admin.command('ping')  # Health check
```

## Colecciones Principales

PathSys maneja **15+ colecciones** organizadas por dominio funcional:

### ğŸ¥ **GestiÃ³n ClÃ­nica**
- `patients` - InformaciÃ³n de pacientes
- `cases` - Casos patolÃ³gicos
- `entities` - Entidades de salud

### ğŸ‘¨â€âš•ï¸ **Personal MÃ©dico**
- `pathologists` - MÃ©dicos patÃ³logos
- `residents` - MÃ©dicos residentes
- `auxiliaries` - Personal auxiliar

### ğŸ”¬ **CatÃ¡logos MÃ©dicos**
- `tests` - CatÃ¡logo de pruebas
- `diseases` - CatÃ¡logo de enfermedades

### ğŸ” **Sistema y Soporte**
- `users` - AutenticaciÃ³n
- `tickets` - Soporte tÃ©cnico
- `billing` - FacturaciÃ³n

### ğŸ“Š **Contadores y Control**
- `case_counters` - Consecutivos de casos
- `approval_counters` - Consecutivos de aprobaciones
- `consecutive_tickets` - Consecutivos de tickets

## CaracterÃ­sticas TÃ©cnicas

### Ãndices y Performance
- **Ãndices Ãºnicos** en cÃ³digos de identificaciÃ³n
- **Ãndices compuestos** para consultas complejas
- **Agregaciones optimizadas** para estadÃ­sticas
- **Proyecciones** para reducir transferencia de datos

### ValidaciÃ³n de Datos
- **Modelos Pydantic** para validaciÃ³n de esquemas
- **Validadores personalizados** para reglas de negocio
- **SerializaciÃ³n automÃ¡tica** de tipos Python a BSON

### Seguridad
- **Conexiones encriptadas** (TLS/SSL)
- **AutenticaciÃ³n** basada en credenciales
- **ValidaciÃ³n de entrada** en todos los endpoints
- **SanitizaciÃ³n** de datos de consulta

## Monitoreo y Mantenimiento

### Logging
```python
logger = logging.getLogger(__name__)
logger.info(f"Conectado a MongoDB: {settings.DATABASE_NAME}")
logger.error(f"Error al conectar con MongoDB: {str(e)}")
```

### Health Checks
- VerificaciÃ³n de conexiÃ³n en startup
- Ping periÃ³dico al servidor
- Manejo de reconexiÃ³n automÃ¡tica

### Backup y RecuperaciÃ³n
- **Desarrollo**: VolÃºmenes Docker persistentes
- **ProducciÃ³n**: Backups automÃ¡ticos de Atlas
- **Scripts de inicializaciÃ³n** para datos de prueba

Esta arquitectura proporciona una base sÃ³lida, escalable y mantenible para el sistema PathSys, adaptÃ¡ndose tanto a entornos de desarrollo como de producciÃ³n.